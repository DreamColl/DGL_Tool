/**
 * Created by xiongjiyuan on 2016/10/24.
 */

var data2 = [
    {"area": "天津", "year": "2016", "turn": "第一轮", "school": "天津工业大学", "score": "6"},
    {"area": "天津", "year": "2016", "turn": "第一轮", "school": "南开大学", "score": "3"},
    {"area": "天津", "year": "2016", "turn": "第一轮", "school": "天津理工大学", "score": "4"},
    {"area": "天津", "year": "2016", "turn": "第一轮", "school": "天津师范大学", "score": "5"},
    {"area": "天津", "year": "2016", "turn": "第一轮", "school": "天津城建大学", "score": "2"},
    {"area": "天津", "year": "2016", "turn": "第一轮", "school": "中国民航大学", "score": "7"},
    {"area": "天津", "year": "2016", "turn": "第一轮", "school": "天津师范大学津沽分校", "score": "7"},
    {"area": "天津", "year": "2016", "turn": "第一轮", "school": "河北工业大学", "score": "2"}
];
var data3 = [
    {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京工商大学", "score": "0", "id": "0120161104"},
    {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京师范大学", "score": "0", "id": "0120161102"},
    {"area": "北京", "year": "2016", "turn": "第一轮", "school": "国际关系学院", "score": "0", "id": "0120161106"},
    {"area": "北京", "year": "2016", "turn": "第一轮", "school": "首都师范大学", "score": "0", "id": "0120161108"},
    {"area": "北京", "year": "2016", "turn": "第一轮", "school": "外交学院", "score": "0", "id": "0120161109"},
    {"area": "北京", "year": "2016", "turn": "第一轮", "school": "中国农业大学", "score": "0", "id": "0120161107"},
    // {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京大学", "score": "0", "id": "0120161102"},
    // {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京大学", "score": "0", "id": "0120161102"},
    // {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京大学", "score": "0", "id": "0120161102"},
    // {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京大学", "score": "0", "id": "0120161102"},
    // {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京大学", "score": "0", "id": "0120161102"},
    // {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京大学", "score": "0", "id": "0120161102"},
    // {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京大学", "score": "0", "id": "0120161102"},
    // {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京大学", "score": "0", "id": "0120161102"},
    // {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京大学", "score": "0", "id": "0120161102"},
    // {"area": "北京", "year": "2016", "turn": "第一轮", "school": "北京大学", "score": "0", "id": "0120161102"}
];
var data20160111 = [
    {"area": "01", "year": "2016", "turn": "11", "school": "110", "score": "5", "id": "20160111110"},
    {"area": "01", "year": "2016", "turn": "11", "school": "116", "score": "4", "id": "20160111116"},
    {"area": "01", "year": "2016", "turn": "11", "school": "109", "score": "8", "id": "20160111109"},
    {"area": "01", "year": "2016", "turn": "11", "school": "113", "score": "1", "id": "20160111113"},
    {"area": "01", "year": "2016", "turn": "11", "school": "108", "score": "2", "id": "20160111108"},
    {"area": "01", "year": "2016", "turn": "11", "school": "106", "score": "7", "id": "20160111106"},
    {"area": "01", "year": "2016", "turn": "11", "school": "111", "score": "9", "id": "20160111111"},
    {"area": "01", "year": "2016", "turn": "11", "school": "102", "score": "0", "id": "20160111102"},
    {"area": "01", "year": "2016", "turn": "11", "school": "101", "score": "3", "id": "20160111101"},
    {"area": "01", "year": "2016", "turn": "11", "school": "114", "score": "6", "id": "20160111114"},
    {"area": "01", "year": "2016", "turn": "11", "school": "112", "score": "8", "id": "20160111112"},
    {"area": "01", "year": "2016", "turn": "11", "school": "103", "score": "1", "id": "20160111103"},
    {"area": "01", "year": "2016", "turn": "11", "school": "104", "score": "4", "id": "20160111104"},
    {"area": "01", "year": "2016", "turn": "11", "school": "107", "score": "5", "id": "20160111107"},
    {"area": "01", "year": "2016", "turn": "11", "school": "105", "score": "5", "id": "20160111105"},
    {"area": "01", "year": "2016", "turn": "11", "school": "115", "score": "4", "id": "20160111115"}
];
var data20160110 = [
    {"area": "01", "year": "2016", "turn": "10", "school": "113", "score": "7", "id": "20160110113"},
    {"area": "01", "year": "2016", "turn": "10", "school": "116", "score": "2", "id": "20160110116"},
    {"area": "01", "year": "2016", "turn": "10", "school": "110", "score": "2", "id": "20160110110"},
    {"area": "01", "year": "2016", "turn": "10", "school": "109", "score": "7", "id": "20160110109"},
    {"area": "01", "year": "2016", "turn": "10", "school": "111", "score": "4", "id": "20160110111"},
    {"area": "01", "year": "2016", "turn": "10", "school": "115", "score": "5", "id": "20160110115"},
    {"area": "01", "year": "2016", "turn": "10", "school": "108", "score": "2", "id": "20160110108"},
    {"area": "01", "year": "2016", "turn": "10", "school": "114", "score": "7", "id": "20160110114"},
    {"area": "01", "year": "2016", "turn": "10", "school": "101", "score": "4", "id": "20160110101"},
    {"area": "01", "year": "2016", "turn": "10", "school": "106", "score": "5", "id": "20160110106"},
    {"area": "01", "year": "2016", "turn": "10", "school": "105", "score": "5", "id": "20160110105"},
    {"area": "01", "year": "2016", "turn": "10", "school": "102", "score": "4", "id": "20160110102"},
    {"area": "01", "year": "2016", "turn": "10", "school": "103", "score": "9", "id": "20160110103"},
    {"area": "01", "year": "2016", "turn": "10", "school": "107", "score": "0", "id": "20160110107"},
    {"area": "01", "year": "2016", "turn": "10", "school": "104", "score": "6", "id": "20160110104"},
    {"area": "01", "year": "2016", "turn": "10", "school": "112", "score": "3", "id": "20160110112"}
];

var db;
const DB_NAME = "test";
const DB_STORE_NAME = "score";
const DB_VERSION = "2";

initDb();

function initDb() {
    var openRequire = indexedDB.open(DB_NAME, DB_VERSION);
    openRequire.onupgradeneeded = function (e) {
        var store = e.target.result.createObjectStore(DB_STORE_NAME, {keyPath: "id"});
    };

    openRequire.onsuccess = function (e) {
        db = e.target.result;
        console.log("init success");
    };

    openRequire.onerror = function (e) {
        console.error("initDb:", e.target.errorCode);
    };
}
function add() {
    if (!db) {
        console.error("add: the db is not initialized");
        return;
    }
    var trans = db.transaction(DB_STORE_NAME, 'readwrite');
    var store = trans.objectStore(DB_STORE_NAME);
    for (var i in data20160110) {
        var req = store.add(data20160110[i]);
    }

    req.onsuccess = function (e) {
        console.log("add success");
    };

    req.onerror = function (e) {
        alert("数据已载入或有重复")
        console.error("add error :", e.target.error);
    }
}
function update() {
    if (!db) {
        console.error("put: the db is not initialized");
        return;
    }
    var trans = db.transaction(DB_STORE_NAME, 'readwrite');
    var store = trans.objectStore(DB_STORE_NAME);
    for (var i in data20160110) {
        var req = store.put(data20160110[i]);
    }

    req.onsuccess = function (e) {
        console.log("put success");
    };

    req.onerror = function (e) {
        alert("数据已载入或有重复")
        console.error("put error :", e.target.error);
    }
}
function check() {
    var trans = db.transaction(DB_STORE_NAME, 'readonly');
    var store = trans.objectStore(DB_STORE_NAME);
    var all = store.getAll();
    var result = all.result;
}

function board() {
    var trans = db.transaction(DB_STORE_NAME, 'readonly');
    var store = trans.objectStore(DB_STORE_NAME);
    var req = store.getAll();
    var result;

    req.onsuccess = function () {
        result = req.result;
        console.log(result);

        boardSort();
    };

    function boardSort() {
        var arr = [];
        for (var j = 101; j < 117; j++) {
            var s = [0, 0, 0, 0];
            s[0] = j;
            for (var i in result) {
                if (result[i].school == j) {
                    if (result[i].score > 6) s[1]++; else s[2]++;
                    s[3] += parseInt(result[i].score);
                }
            }
            arr.push(s);
        }
        var arrBoard = arr.sort(function (x, y) {
            if (x[1] == y[1]) return -(x[3] - y[3]); else return -(x[1] - y[1]);
        });
        console.log(arr, arrBoard);
    }

}
